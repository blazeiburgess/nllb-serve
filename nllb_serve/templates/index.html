{% extends 'base.html' %}

{% block content %}
    <div class="container mt-5">
        <h1 class="text-center mb-4">{% block title %}No Language Left Behind{% endblock %}</h1>
        <p class="text-center fs-5 mb-4">Currently serving <code class="bg-light p-1 rounded">{{ model_id }}</code></p>

        <form id="source-form" action="./translate">
            <div class="row mb-4">
                <div class="col-md-5">
                    <div class="d-flex align-items-center">
                        <label for="src_lang_input" class="form-label me-2">From:</label>
                        <div class="position-relative w-100">
                            <input type="text" id="src_lang_input" class="form-control"
                                   placeholder="Search language...">
                            <input type="hidden" id="src_lang" name="src_lang" value="{{ def_src_lang.strip() }}">
                            <ul id="src_lang_list" class="list-group position-absolute w-100"
                                style="display:none; max-height: 200px; overflow-y: auto; z-index: 1000;">
                                {% for src_lang in src_langs %}
                                    <li class="list-group-item"
                                        data-value="{{ src_lang }}">
                                        <span class="fw-bold">{{ language_mapper[src_lang][1] }}</span>, {{ language_mapper[src_lang][0] }}
                                        ({{ src_lang }})
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 text-center">
                    <button id="button-swap" type="button" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left-right"></i> Swap
                    </button>
                </div>
                <div class="col-md-5">
                    <div class="d-flex align-items-center justify-content-end">
                        <label for="tgt_lang_input" class="form-label me-2">To:</label>
                        <div class="position-relative w-100">
                            <input type="text" id="tgt_lang_input" class="form-control"
                                   placeholder="Search language...">
                            <input type="hidden" id="tgt_lang" name="tgt_lang" value="{{ def_tgt_lang }}">
                            <ul id="tgt_lang_list" class="list-group position-absolute w-100"
                                style="display:none; max-height: 200px; overflow-y: auto; z-index: 1000;">
                                {% for tgt_lang in tgt_langs %}
                                    <li class="list-group-item"
                                        data-value="{{ tgt_lang }}">
                                        <span class="fw-bold">{{ language_mapper[tgt_lang][1] }}</span>, {{ language_mapper[tgt_lang][0] }}
                                        ({{ tgt_lang }})
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-header bg-primary text-white">Source Text</div>
                        <div class="card-body">
                            <textarea id="source_txt" name="source" rows="6" class="form-control custom-textarea"
                                      placeholder="Enter source text here..."></textarea>
                        </div>
                    </div>
                    <div class="text-end mt-2">
                        <button type="submit" class="btn btn-primary">Translate →</button>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-header bg-success text-white">Translation</div>
                        <div class="card-body">
                            <textarea id="target" rows="6" class="form-control custom-textarea"
                                      placeholder="Translation will appear here..." readonly></textarea>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end align-items-center mt-2">
                        <div id="loading-progress" class="spinner-border text-success me-2" role="status"
                             style="display:none;"></div>
                        <p class="text me-2 mb-0" id="time-taken">...</p>
                        <button type="button" class="btn btn-success" onclick="copyToClipboard()">Copy to Clipboard
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script>


        function copyToClipboard() {
            const targetText = document.getElementById('target').value;
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(targetText).then(() => {
                    {#alert('Copied to clipboard!');#}
                }).catch((err) => {
                    console.error('Failed to copy: ', err);
                });
            } else {
                // Fallback to execCommand
                let textArea = document.createElement("textarea");
                textArea.value = targetText;
                textArea.style.position = "fixed";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('Copied to clipboard!');
                } catch (err) {
                    console.error('Failed to copy: ', err);
                }
                document.body.removeChild(textArea);
            }
        }

        var last_result = null

        function update_view(result) {
            console.log(result)
            last_result = result
            $('#target').val(result["translation"].join('\n'));
            $('#time-taken').text('⏳' + result["time_taken"] + result.time_units);
        }

        function swap_direction() {
            console.log("swapping...")
            // langs
            src_lang = $('#src_lang').val()
            $('#src_lang').val($('#tgt_lang').val())
            $('#tgt_lang').val(src_lang)
            // swap text
            src_txt = $('#source_txt').val().trim()
            $('#source_txt').val($('#target').val().trim())
            $('#target').val(src_txt)
        }

        window.onload = function () {
            $(document).ajaxStart(function () {
                $("#loading-progress").show();
            });

            $(document).ajaxStop(function () {
                $("#loading-progress").hide();
            });


            $("#source-form").submit(function (event) {
                event.preventDefault();
                var $form = $(this)
                url = $form.attr('action');
                source = $('#source_txt').val().trim().split('\n')
                src_lang = $('#src_lang').val()
                tgt_lang = $('#tgt_lang').val()
                sen_split = $('#ssplit_checkbox').prop('checked')

                data = JSON.stringify({
                    'source': source,
                    'src_lang': src_lang,
                    'tgt_lang': tgt_lang,
                    'sen_split': sen_split
                })
                console.log(data);

                var posting = $.ajax(url, {
                    data: data,
                    contentType: 'application/json',
                    type: 'POST'
                });

                posting.done(update_view)
                posting.fail(function (result) {
                    alert(result.responseText);
                    $('#target').text('');
                });
            });

            $("#button-swap").click(swap_direction)
        }

        document.getElementById('source_txt').addEventListener('keydown', function (event) {
            if (event.ctrlKey && event.key === 'Enter') {
                event.preventDefault();
                $("#source-form").submit();
            }
        });

        function setupLanguageFilter(inputId, hiddenInputId, listId) {
            const input = document.getElementById(inputId);
            const hiddenInput = document.getElementById(hiddenInputId);
            const list = document.getElementById(listId);
            const items = list.getElementsByTagName('li');

            // Set initial value
            const initialSelectedItem = Array.from(items).find(item => item.dataset.value === hiddenInput.value);
            if (initialSelectedItem) {
                input.value = initialSelectedItem.textContent;
            }

            input.addEventListener('focus', () => list.style.display = 'block');
            input.addEventListener('blur', () => setTimeout(() => list.style.display = 'none', 200));

            input.addEventListener('keyup', function () {
                const filter = this.value.toUpperCase();
                for (let i = 0; i < items.length; i++) {
                    const txtValue = items[i].textContent || items[i].innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        items[i].style.display = "";
                    } else {
                        items[i].style.display = "none";
                    }
                }
            });

            list.addEventListener('click', function (e) {
                if (e.target && e.target.nodeName === "LI") {
                    input.value = e.target.textContent;
                    hiddenInput.value = e.target.dataset.value;
                    list.style.display = 'none';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            setupLanguageFilter('src_lang_input', 'src_lang', 'src_lang_list');
            setupLanguageFilter('tgt_lang_input', 'tgt_lang', 'tgt_lang_list');
        });


    </script>

{% endblock %}
